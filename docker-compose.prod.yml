version: '3.8'

services:
  # API de prédiction climatique
  climate-api:
    build:
      context: .
      dockerfile: Dockerfile.train
    ports:
      - "8000:8000"
    volumes:
      - ./:/workspace
      - ./models:/workspace/models
    working_dir: /workspace/src
    command: python api.py
    depends_on:
      - mlflow
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - PYTHONPATH=/workspace/src
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MLflow pour le tracking et serving
  mlflow:
    build:
      context: .
      dockerfile: Dockerfile.train
    ports:
      - "5050:5000"
    volumes:
      - ./:/workspace
      - mlflow_artifacts:/mlruns
      - ./models:/workspace/models
    working_dir: /workspace
    command: mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow.db --default-artifact-root /mlruns
    restart: unless-stopped

  # Jupyter Lab pour le développement
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile.train
    ports:
      - "8889:8888"
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token=''
    restart: unless-stopped

  # Service d'entraînement périodique (optionnel)
  training-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.train
    volumes:
      - ./:/workspace
      - ./models:/workspace/models
    working_dir: /workspace/src
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - PYTHONPATH=/workspace/src
    depends_on:
      - mlflow
    # Entraînement périodique via cron (décommentez si nécessaire)
    # command: |
    #   sh -c "
    #   echo '0 2 * * 0 cd /workspace/src && python train_model.py --optimize --trials 100' | crontab -
    #   crond -f
    #   "
    command: "tail -f /dev/null"  # Garde le conteneur en vie
    restart: unless-stopped

volumes:
  mlflow_artifacts: